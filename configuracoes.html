<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <title>Configura√ß√µes - Controle Financeiro</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <nav>
      <h1>Controle Financeiro</h1>
      <ul>
        <li><a href="home.html">In√≠cio</a></li>
        <li><a href="relatorio.html">Relat√≥rio Mensal</a></li>
        <li><a href="historico.html">Hist√≥rico</a></li>
        <li><a href="configuracoes.html" class="active">Configura√ß√µes</a></li>
        <li><button id="btnLogout">Sair</button></li>
      </ul>
    </nav>

    <main class="container">
      <h2>Configura√ß√µes do Sistema</h2>

      <div class="config-form">
        <div class="card">
          <h3>Configura√ß√£o Salarial</h3>
          <label for="salarioBase">Sal√°rio Base</label>
          <input type="number" id="salarioBase" placeholder="R$ 0,00" />
          
          <label for="diaPagamentoFinal">Dia do Pagamento</label>
          <input 
            type="number" 
            id="diaPagamentoFinal" 
            min="1" 
            max="31" 
            placeholder="Ex: 30"
          />
          
          <div class="checkbox-group">
            <input type="checkbox" id="temAdiantamento" />
            <label for="temAdiantamento">Recebe adiantamento salarial</label>
          </div>

          <div id="configAdiantamento" style="display: none;">
            <label for="porcentagemAdiantamento">Porcentagem do Adiantamento</label>
            <div class="input-percentage">
              <input 
                type="number" 
                id="porcentagemAdiantamento" 
                min="1" 
                max="100" 
                placeholder="Ex: 40"
              />
              <span class="percentage-symbol">%</span>
            </div>

            <label for="diaAdiantamento">Dia do Adiantamento</label>
            <input 
              type="number" 
              id="diaAdiantamento" 
              min="1" 
              max="31" 
              placeholder="Ex: 15"
            />
          </div>

          <div class="checkbox-group">
            <input type="checkbox" id="temInvestimento" />
            <label for="temInvestimento">Investir parte do sal√°rio</label>
          </div>

          <div id="configInvestimento" style="display: none;">
            <div class="input-group">
              <label for="porcentagemInvestimento">Porcentagem do Investimento</label>
              <div class="input-percentage">
                <input 
                  type="number" 
                  id="porcentagemInvestimento" 
                  min="1" 
                  max="100" 
                  placeholder="Ex: 10"
                />
                <span class="percentage-symbol">%</span>
              </div>
            </div>

            <div class="input-group">
              <label for="valorFixoInvestimento">Valor Fixo do Investimento</label>
              <div class="input-money">
                <span class="money-symbol">R$</span>
                <input 
                  type="number" 
                  id="valorFixoInvestimento" 
                  min="0" 
                  placeholder="Ex: 500,00"
                />
              </div>
            </div>
          </div>

          <button id="btnSalvarSalario" class="btn-blue">Salvar Configura√ß√£o Salarial</button>

          <div class="previsao-pagamento">
            <h4>Previs√£o de Pagamento</h4>
            <div class="previsao-grid">
              <div class="previsao-item">
                <span class="previsao-label">Sal√°rio Bruto:</span>
                <span id="previsaoSalarioBruto" class="previsao-valor">R$ 0,00</span>
              </div>
              
              <div id="previsaoAdiantamentoContainer" class="previsao-item" style="display: none;">
                <span class="previsao-label">Adiantamento:</span>
                <span id="previsaoAdiantamento" class="previsao-valor">R$ 0,00</span>
                <span id="previsaoDataAdiantamento" class="previsao-data"></span>
              </div>
          
              <div id="previsaoInvestimentoContainer" class="previsao-item" style="display: none;">
                <span class="previsao-label">Investimento:</span>
                <span id="previsaoInvestimento" class="previsao-valor">R$ 0,00</span>
              </div>
          
              <div class="previsao-item destaque">
                <span class="previsao-label">Sal√°rio Final:</span>
                <span id="previsaoSalarioFinal" class="previsao-valor">R$ 0,00</span>
                <span id="previsaoDataPagamento" class="previsao-data"></span>
              </div>
            </div>
          </div>
        </div>

        <!-- Modifique a div da configura√ß√£o do relat√≥rio mensal -->
        <div class="card">
          <h3>Configura√ß√£o do Relat√≥rio Mensal</h3>
          <div class="maintenance-message">
            üöß Em manuten√ß√£o - Esta funcionalidade estar√° dispon√≠vel em breve!
          </div>
          
          <p class="config-info">Define o per√≠odo de contagem do relat√≥rio mensal</p>
          
          <label for="diaInicio">Dia de In√≠cio</label>
          <input type="number" id="diaInicio" min="1" max="31" placeholder="Ex: 20" disabled />
          
          <label for="diaFim">Dia de Fechamento</label>
          <input type="number" id="diaFim" min="1" max="31" placeholder="Ex: 19" disabled />

          <button id="btnSalvarPeriodo" class="btn-blue" disabled>
            Salvar Configura√ß√£o do Per√≠odo
          </button>
        </div>
      </div>
    </main>

    <button id="themeToggle" class="theme-toggle" aria-label="Alternar tema">
      üåì
    </button>

    <script type="module">
      import { auth } from './firebase-config.js';
      import { checkAuth, logout } from "./auth.js";
      import { salvarConfiguracoes, carregarConfiguracoes } from "./config.js";
      import { atualizarRodape } from "./finance.js";
      import { formatarData } from "./date-utils.js";

      // Fun√ß√µes globais
      window.formatarMoeda = function(valor) {
        return `R$ ${Number(valor).toFixed(2)}`;
      };

      window.atualizarPrevisao = function() {
        const hoje = new Date();
        const mesAtual = hoje.getMonth() + 1;
        const anoAtual = hoje.getFullYear();

        const salarioBase = parseFloat(document.getElementById("salarioBase").value) || 0;
        const temAdiantamento = document.getElementById("temAdiantamento").checked;
        const porcentagemAdiantamento = parseFloat(document.getElementById("porcentagemAdiantamento").value) || 0;
        const diaAdiantamento = parseInt(document.getElementById("diaAdiantamento").value) || 0;
        const diaPagamento = parseInt(document.getElementById("diaPagamentoFinal").value) || 0;

        const temInvestimento = document.getElementById("temInvestimento").checked;
        const porcentagemInvestimento = parseFloat(document.getElementById("porcentagemInvestimento").value) || 0;
        const valorFixoInvestimento = parseFloat(document.getElementById("valorFixoInvestimento").value) || 0;

        // Atualiza sal√°rio bruto
        document.getElementById("previsaoSalarioBruto").textContent = formatarMoeda(salarioBase);

        // Calcula valores de investimento
        let valorInvestimentoTotal = 0;
        if (temInvestimento && salarioBase > 0) {
          valorInvestimentoTotal = valorFixoInvestimento || (salarioBase * porcentagemInvestimento / 100);
        }

        // Atualiza adiantamento
        const previsaoAdiantamentoContainer = document.getElementById("previsaoAdiantamentoContainer");
        if (temAdiantamento && salarioBase > 0 && porcentagemAdiantamento > 0) {
          const valorAdiantamento = (salarioBase * porcentagemAdiantamento) / 100;
          const valorInvestimentoAdiantamento = temInvestimento ? 
            (valorInvestimentoTotal * valorAdiantamento / salarioBase) : 0;

          document.getElementById("previsaoAdiantamento").textContent = 
            formatarMoeda(valorAdiantamento - valorInvestimentoAdiantamento);
          document.getElementById("previsaoDataAdiantamento").textContent = 
            diaAdiantamento ? ` (${formatarData(diaAdiantamento, mesAtual, anoAtual)})` : '';
          previsaoAdiantamentoContainer.style.display = "flex";
        } else {
          previsaoAdiantamentoContainer.style.display = "none";
        }

        // Atualiza investimento
        const previsaoInvestimentoContainer = document.getElementById("previsaoInvestimentoContainer");
        if (temInvestimento && salarioBase > 0) {
          document.getElementById("previsaoInvestimento").textContent = formatarMoeda(valorInvestimentoTotal);
          previsaoInvestimentoContainer.style.display = "flex";
        } else {
          previsaoInvestimentoContainer.style.display = "none";
        }

        // Calcula sal√°rio final (corre√ß√£o do c√°lculo)
        let salarioFinal = salarioBase;
        let valorAdiantamento = 0;
        let valorInvestimentoAdiantamento = 0;
        
        if (temAdiantamento && salarioBase > 0) {
          valorAdiantamento = (salarioBase * porcentagemAdiantamento) / 100;
          
          // Se tem investimento, calcula a parte proporcional do adiantamento
          if (temInvestimento) {
            valorInvestimentoAdiantamento = (valorInvestimentoTotal * valorAdiantamento) / salarioBase;
            // O adiantamento j√° tem o desconto do investimento proporcional
            salarioFinal -= (valorAdiantamento - valorInvestimentoAdiantamento);
          } else {
            // Se n√£o tem investimento, desconta s√≥ o adiantamento
            salarioFinal -= valorAdiantamento;
          }
        }

        // Se tem investimento, desconta apenas a parte do investimento que n√£o foi descontada no adiantamento
        if (temInvestimento && salarioBase > 0) {
          const valorInvestimentoRestante = valorInvestimentoTotal - valorInvestimentoAdiantamento;
          salarioFinal -= valorInvestimentoRestante;
        }
        
        document.getElementById("previsaoSalarioFinal").textContent = formatarMoeda(salarioFinal);
        document.getElementById("previsaoDataPagamento").textContent = 
          diaPagamento ? ` (${formatarData(diaPagamento, mesAtual, anoAtual)})` : '';
      };

      // Event listeners for checkboxes
      document.getElementById("temAdiantamento")?.addEventListener('change', function() {
        const configAdiantamento = document.getElementById("configAdiantamento");
        configAdiantamento.style.display = this.checked ? 'block' : 'none';
        
        if (!this.checked) {
          document.getElementById("porcentagemAdiantamento").value = '';
          document.getElementById("diaAdiantamento").value = '';
        }
        window.atualizarPrevisao();
      });

      document.getElementById("temInvestimento")?.addEventListener('change', function() {
        const configInvestimento = document.getElementById("configInvestimento");
        configInvestimento.style.display = this.checked ? 'block' : 'none';
        
        if (!this.checked) {
          document.getElementById("porcentagemInvestimento").value = '';
          document.getElementById("valorFixoInvestimento").value = '';
        }
        window.atualizarPrevisao();
      });

      // Event listener for salary base
      document.getElementById("salarioBase")?.addEventListener('input', function() {
        const salarioBase = parseFloat(this.value) || 0;
        const checkboxInvestimento = document.getElementById("temInvestimento");
        const checkboxAdiantamento = document.getElementById("temAdiantamento");
        
        checkboxInvestimento.disabled = salarioBase <= 0;
        checkboxAdiantamento.disabled = salarioBase <= 0;
        
        if (salarioBase <= 0) {
          checkboxInvestimento.checked = false;
          checkboxAdiantamento.checked = false;
          document.getElementById("configInvestimento").style.display = 'none';
          document.getElementById("configAdiantamento").style.display = 'none';
        }
        
        window.atualizarPrevisao();
      });

      // Event listeners for all input fields
      ['porcentagemAdiantamento', 'diaAdiantamento', 'diaPagamentoFinal', 
       'porcentagemInvestimento', 'valorFixoInvestimento'].forEach(id => {
        document.getElementById(id)?.addEventListener('input', window.atualizarPrevisao);
      });

      async function initApp() {
        try {
          const user = await checkAuth();
          if (!user) {
            window.location.href = 'index.html';
            return;
          }

          console.log("Usu√°rio autenticado, iniciando setup..."); // Debug
          
          // Configura os eventos primeiro
          setupEventListeners();

          // Depois carrega as configura√ß√µes
          const config = await carregarConfiguracoes();
          if (config) {
            preencherFormulario(config);
          }

          // Por √∫ltimo carrega o rodap√©
          await loadFooter();
          
          console.log("Inicializa√ß√£o conclu√≠da"); // Debug

        } catch (error) {
          console.error("Erro na inicializa√ß√£o:", error);
        }
      }

      // Fun√ß√£o para carregar o rodap√©
      async function loadFooter() {
        try {
          const response = await fetch('footer.html');
          const html = await response.text();
          const tempDiv = document.createElement('div');
          tempDiv.innerHTML = html;
          document.body.appendChild(tempDiv.firstElementChild);
          await atualizarRodape();
        } catch (error) {
          console.error("Erro ao carregar rodap√©:", error);
        }
      }

      async function loadConfig() {
        try {
          const config = await carregarConfiguracoes();
          if (config) {
            preencherFormulario(config);
          }
        } catch (error) {
          console.error("Erro ao carregar configura√ß√µes:", error);
          alert("Erro ao carregar configura√ß√µes");
        }
      }

      // Inicia a aplica√ß√£o quando o DOM estiver pronto
      document.addEventListener('DOMContentLoaded', initApp);

      // Fun√ß√£o para preencher o formul√°rio com configura√ß√µes existentes
      function preencherFormulario(config) {
        document.getElementById("salarioBase").value = config.salarioBase || '';
        document.getElementById("temAdiantamento").checked = config.temAdiantamento || false;
        document.getElementById("porcentagemAdiantamento").value = config.porcentagemAdiantamento || '';
        document.getElementById("diaAdiantamento").value = config.diaAdiantamento || '';
        document.getElementById("diaPagamentoFinal").value = config.diaPagamentoFinal || '';
        
        // Mostra/esconde configura√ß√£o de adiantamento
        document.getElementById("configAdiantamento").style.display = 
          config.temAdiantamento ? 'block' : 'none';

        document.getElementById("temInvestimento").checked = config.temInvestimento || false;
        document.getElementById("porcentagemInvestimento").value = config.porcentagemInvestimento || '';
        document.getElementById("valorFixoInvestimento").value = config.valorFixoInvestimento || '';
        
        // Atualiza visibilidade do investimento
        document.getElementById("configInvestimento").style.display = 
          config.temInvestimento ? 'block' : 'none';

        atualizarPrevisao();
      }

      // Adicione esta fun√ß√£o para salvar as configura√ß√µes
      async function salvarConfiguracoesUsuario() {
        try {
          console.log("Iniciando salvamento..."); // Debug
          const config = {
            salarioBase: parseFloat(document.getElementById("salarioBase").value) || 0,
            temAdiantamento: document.getElementById("temAdiantamento").checked,
            porcentagemAdiantamento: parseInt(document.getElementById("porcentagemAdiantamento").value) || 0,
            diaAdiantamento: parseInt(document.getElementById("diaAdiantamento").value) || 0,
            diaPagamentoFinal: parseInt(document.getElementById("diaPagamentoFinal").value) || 0,
            temInvestimento: document.getElementById("temInvestimento").checked,
            porcentagemInvestimento: parseFloat(document.getElementById("porcentagemInvestimento").value) || 0,
            valorFixoInvestimento: parseFloat(document.getElementById("valorFixoInvestimento").value) || 0
          };

          console.log("Configura√ß√µes a salvar:", config); // Debug

          // Valida√ß√µes b√°sicas
          if (!config.salarioBase) {
            throw new Error("O sal√°rio base √© obrigat√≥rio!");
          }
          if (!config.diaPagamentoFinal) {
            throw new Error("O dia do pagamento √© obrigat√≥rio!");
          }
          if (config.temAdiantamento && (!config.diaAdiantamento || !config.porcentagemAdiantamento)) {
            throw new Error("Com adiantamento, √© necess√°rio informar dia e porcentagem!");
          }
          if (config.temInvestimento && (!config.porcentagemInvestimento && !config.valorFixoInvestimento)) {
            throw new Error("Com investimento, √© necess√°rio informar porcentagem ou valor fixo!");
          }

          const anoAtual = new Date().getFullYear();
          const anosFuturos = 2100 - anoAtual;
          const mesesTotais = anosFuturos * 12;

          if (confirm(`Deseja criar as transa√ß√µes salariais para todos os meses at√© 2100? (Aproximadamente ${mesesTotais} meses)\n\nIsso ir√° atualizar todas as transa√ß√µes futuras a partir do m√™s atual.`)) {
            await salvarConfiguracoes(config);
            alert(`Configura√ß√µes salvas com sucesso!\n\n‚úì Sal√°rio base: R$ ${config.salarioBase}\n‚úì Dia do pagamento: ${config.diaPagamentoFinal}\n${config.temAdiantamento ? `‚úì Adiantamento: ${config.porcentagemAdiantamento}% no dia ${config.diaAdiantamento}\n` : ''}${config.temInvestimento ? `‚úì Investimento: ${config.porcentagemInvestimento}%\n` : ''}\n‚úì Transa√ß√µes geradas at√© 2100`);
            await atualizarRodape();
          }
        } catch (error) {
          console.error("Erro ao salvar:", error); // Debug
          alert("Erro ao salvar configura√ß√µes: " + error.message);
        }
      }

      // Setup dos event listeners
      function setupEventListeners() {
        document.getElementById("btnLogout").onclick = logout;

        // Configurar visibility do adiantamento
        const checkboxAdiantamento = document.getElementById("temAdiantamento");
        const configAdiantamento = document.getElementById("configAdiantamento");

        checkboxAdiantamento.addEventListener('change', () => {
          configAdiantamento.style.display = checkboxAdiantamento.checked ? 'block' : 'none';
          if (!checkboxAdiantamento.checked) {
            document.getElementById("porcentagemAdiantamento").value = '';
            document.getElementById("diaAdiantamento").value = '';
          }
          atualizarPrevisao(); // Adiciona chamada para atualizar previs√£o
        });

        // Configurar checkbox de investimento
        const salarioBaseInput = document.getElementById("salarioBase");
        const checkboxInvestimento = document.getElementById("temInvestimento");
        const configInvestimento = document.getElementById("configInvestimento");
        const porcentagemInvestimentoInput = document.getElementById("porcentagemInvestimento");
        const valorFixoInvestimentoInput = document.getElementById("valorFixoInvestimento");

        // Habilitar checkbox de investimento apenas quando sal√°rio base estiver preenchido
        salarioBaseInput.addEventListener('input', () => {
          const salarioBase = parseFloat(salarioBaseInput.value) || 0;
          checkboxInvestimento.disabled = salarioBase <= 0;
          checkboxAdiantamento.disabled = salarioBase <= 0;
          
          if (salarioBase <= 0) {
            checkboxInvestimento.checked = false;
            checkboxAdiantamento.checked = false;
            configInvestimento.style.display = 'none';
            configAdiantamento.style.display = 'none';
          }
        });

        // Toggle da visibilidade dos campos de investimento
        checkboxInvestimento.addEventListener('change', () => {
          configInvestimento.style.display = checkboxInvestimento.checked ? 'block' : 'none';
          if (!checkboxInvestimento.checked) {
            porcentagemInvestimentoInput.value = '';
            valorFixoInvestimentoInput.value = '';
          }
          atualizarPrevisao(); // Adiciona chamada para atualizar previs√£o
        });

        // Calcular valor fixo quando porcentagem √© alterada
        porcentagemInvestimentoInput.addEventListener('input', () => {
          if (porcentagemInvestimentoInput.value) {
            const salarioBase = parseFloat(salarioBaseInput.value) || 0;
            const porcentagem = parseFloat(porcentagemInvestimentoInput.value) || 0;
            const valorFixo = (salarioBase * porcentagem / 100).toFixed(2);
            valorFixoInvestimentoInput.value = valorFixo;
          }
        });

        // Calcular porcentagem quando valor fixo √© alterado
        valorFixoInvestimentoInput.addEventListener('input', () => {
          if (valorFixoInvestimentoInput.value) {
            const salarioBase = parseFloat(salarioBaseInput.value) || 0;
            const valorFixo = parseFloat(valorFixoInvestimentoInput.value) || 0;
            const porcentagem = ((valorFixo / salarioBase) * 100).toFixed(2);
            porcentagemInvestimentoInput.value = porcentagem;
          }
        });

        // Fun√ß√£o para formatar valores em reais
        function formatarMoeda(valor) {
          return `R$ ${valor.toFixed(2)}`;
        }

        // Atualiza a fun√ß√£o atualizarPrevisao
        function atualizarPrevisao() {
          const hoje = new Date();
          const mesAtual = hoje.getMonth() + 1;
          const anoAtual = hoje.getFullYear();

          const salarioBase = parseFloat(salarioBaseInput.value) || 0;
          const temAdiantamento = checkboxAdiantamento.checked;
          const porcentagemAdiantamento = parseFloat(document.getElementById("porcentagemAdiantamento").value) || 0;
          const diaAdiantamento = parseInt(document.getElementById("diaAdiantamento").value) || 0;
          const diaPagamento = parseInt(document.getElementById("diaPagamentoFinal").value) || 0;

          const temInvestimento = checkboxInvestimento.checked;
          const porcentagemInvestimento = parseFloat(porcentagemInvestimentoInput.value) || 0;
          const valorFixoInvestimento = parseFloat(valorFixoInvestimentoInput.value) || 0;

          // Atualiza sal√°rio bruto
          document.getElementById("previsaoSalarioBruto").textContent = formatarMoeda(salarioBase);

          // Calcula valores de investimento
          let valorInvestimentoTotal = 0;
          if (temInvestimento && salarioBase > 0) {
            valorInvestimentoTotal = valorFixoInvestimento || (salarioBase * porcentagemInvestimento / 100);
          }

          // Atualiza adiantamento
          const previsaoAdiantamentoContainer = document.getElementById("previsaoAdiantamentoContainer");
          if (temAdiantamento && salarioBase > 0 && porcentagemAdiantamento > 0) {
            const valorAdiantamento = (salarioBase * porcentagemAdiantamento) / 100;
            const valorInvestimentoAdiantamento = temInvestimento ? 
              (valorInvestimentoTotal * valorAdiantamento / salarioBase) : 0;

            document.getElementById("previsaoAdiantamento").textContent = 
              formatarMoeda(valorAdiantamento - valorInvestimentoAdiantamento);
            document.getElementById("previsaoDataAdiantamento").textContent = 
              diaAdiantamento ? ` (${formatarData(diaAdiantamento, mesAtual, anoAtual)})` : '';
            previsaoAdiantamentoContainer.style.display = "flex";
          } else {
            previsaoAdiantamentoContainer.style.display = "none";
          }

          // Atualiza investimento
          const previsaoInvestimentoContainer = document.getElementById("previsaoInvestimentoContainer");
          if (temInvestimento && salarioBase > 0) {
            document.getElementById("previsaoInvestimento").textContent = formatarMoeda(valorInvestimentoTotal);
            previsaoInvestimentoContainer.style.display = "flex";
          } else {
            previsaoInvestimentoContainer.style.display = "none";
          }

          // Calcula sal√°rio final (corre√ß√£o do c√°lculo)
          let salarioFinal = salarioBase;
          let valorAdiantamento = 0;
          let valorInvestimentoAdiantamento = 0;
          
          if (temAdiantamento && salarioBase > 0) {
            valorAdiantamento = (salarioBase * porcentagemAdiantamento) / 100;
            
            // Se tem investimento, calcula a parte proporcional do adiantamento
            if (temInvestimento) {
              valorInvestimentoAdiantamento = (valorInvestimentoTotal * valorAdiantamento) / salarioBase;
              // O adiantamento j√° tem o desconto do investimento proporcional
              salarioFinal -= (valorAdiantamento - valorInvestimentoAdiantamento);
            } else {
              // Se n√£o tem investimento, desconta s√≥ o adiantamento
              salarioFinal -= valorAdiantamento;
            }
          }

          // Se tem investimento, desconta apenas a parte do investimento que n√£o foi descontada no adiantamento
          if (temInvestimento && salarioBase > 0) {
            const valorInvestimentoRestante = valorInvestimentoTotal - valorInvestimentoAdiantamento;
            salarioFinal -= valorInvestimentoRestante;
          }
          
          document.getElementById("previsaoSalarioFinal").textContent = formatarMoeda(salarioFinal);
          document.getElementById("previsaoDataPagamento").textContent = 
            diaPagamento ? ` (${formatarData(diaPagamento, mesAtual, anoAtual)})` : '';
        }

        // Adicione os event listeners para atualizar a previs√£o
        const camposParaMonitorar = [
          salarioBaseInput,
          checkboxAdiantamento,
          document.getElementById("porcentagemAdiantamento"),
          document.getElementById("diaAdiantamento"),
          document.getElementById("diaPagamentoFinal"),
          checkboxInvestimento,
          porcentagemInvestimentoInput,
          valorFixoInvestimentoInput
        ];

        camposParaMonitorar.forEach(campo => {
          campo.addEventListener('input', atualizarPrevisao);
          campo.addEventListener('change', atualizarPrevisao);
        });

        // Adicione este trecho para garantir que todos os campos est√£o sendo monitorados
        const todosOsCampos = [
          salarioBaseInput,
          checkboxAdiantamento,
          document.getElementById("porcentagemAdiantamento"),
          document.getElementById("diaAdiantamento"),
          document.getElementById("diaPagamentoFinal"),
          checkboxInvestimento,
          porcentagemInvestimentoInput,
          valorFixoInvestimentoInput
        ];

        todosOsCampos.forEach(campo => {
          if (campo) {
            ['input', 'change'].forEach(evento => {
              campo.addEventListener(evento, atualizarPrevisao);
            });
          }
        });

        // Atualizar previs√£o tamb√©m quando carregar as configura√ß√µes
        const carregamentoOriginal = window.addEventListener('load', async () => {
          const config = await carregarConfiguracoes();
          if (config) {
            document.getElementById("salarioBase").value = config.salarioBase || '';
            document.getElementById("temAdiantamento").checked = config.temAdiantamento || false;
            document.getElementById("porcentagemAdiantamento").value = config.porcentagemAdiantamento || '';
            document.getElementById("diaAdiantamento").value = config.diaAdiantamento || '';
            document.getElementById("diaPagamentoFinal").value = config.diaPagamentoFinal || '';
            
            // Mostra/esconde configura√ß√£o de adiantamento baseado no checkbox
            configAdiantamento.style.display = config.temAdiantamento ? 'block' : 'none';

            document.getElementById("temInvestimento").checked = config.temInvestimento || false;
            document.getElementById("porcentagemInvestimento").value = config.porcentagemInvestimento || '';
            document.getElementById("valorFixoInvestimento").value = config.valorFixoInvestimento || '';
            
            // Atualizar visibilidade do investimento
            configInvestimento.style.display = config.temInvestimento ? 'block' : 'none';
            
            // Verificar sal√°rio base para habilitar checkboxes
            const salarioBase = parseFloat(config.salarioBase) || 0;
            checkboxInvestimento.disabled = salarioBase <= 0;
            checkboxAdiantamento.disabled = salarioBase <= 0;

            atualizarPrevisao(); // Adicione esta linha
          }
        });

        // Modifique o evento do btnSalvarSalario
        const btnSalvarSalario = document.getElementById("btnSalvarSalario");
        if (btnSalvarSalario) {
          btnSalvarSalario.onclick = salvarConfiguracoesUsuario;
          console.log("Evento de salvar configurado"); // Debug
        }

        // Salvar configura√ß√µes do per√≠odo
        document.getElementById("btnSalvarPeriodo").onclick = async () => {
          const diaInicio = parseInt(document.getElementById("diaInicio").value) || 20;
          const diaFim = parseInt(document.getElementById("diaFim").value) || 19;

          await salvarConfiguracoes({
            diaInicio,
            diaFim
          });
        };

        // Atualiza o rodap√© quando a p√°gina carregar
        document.addEventListener('DOMContentLoaded', async () => {
          await checkAuth();
          await atualizarRodape();
        });
      }
    </script>

    <script src="theme.js"></script>

    <!-- Remover este bloco de todas as p√°ginas -->
    <script type="text/html" id="footer-template">
        <!-- Conte√∫do do footer.html aqui -->
    </script>
  </body>
</html>